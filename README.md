# QRKot

<h4>Автор:</h4>

**Изимов Арсений**  - студент Яндекс.Практикума Когорта 16+
https://github.com/Arseny13


<h2>Задание</h2>

Ваша задача — создать приложение для Благотворительного фонда поддержки котиков QRKot. 
Фонд собирает пожертвования на различные целевые проекты: на медицинское обслуживание нуждающихся хвостатых, на обустройство кошачьей колонии в подвале, на корм оставшимся без попечения кошкам — на любые цели, связанные с поддержкой кошачьей популяции..

<h2>Техническое описание проекта</h2>

Проекты

В Фонде QRKot может быть открыто несколько целевых проектов. У каждого проекта есть название, описание и сумма, которую планируется собрать. После того, как нужная сумма собрана — проект закрывается.

Пожертвования в проекты поступают по принципу First In, First Out: все пожертвования идут в проект, открытый раньше других; когда этот проект набирает необходимую сумму и закрывается — пожертвования начинают поступать в следующий проект.

Пожертвования

Каждый пользователь может сделать пожертвование и сопроводить его комментарием. Пожертвования не целевые: они вносятся в фонд, а не в конкретный проект. Каждое полученное пожертвование автоматически добавляется в первый открытый проект, который ещё не набрал нужную сумму. Если пожертвование больше нужной суммы или же в Фонде нет открытых проектов — оставшиеся деньги ждут открытия следующего проекта. При создании нового проекта все неинвестированные пожертвования автоматически вкладываются в новый проект.

Пользователи

Целевые проекты создаются администраторами сайта. 
Любой пользователь может видеть список всех проектов, включая требуемые и уже внесенные суммы. Это касается всех проектов — и открытых, и закрытых.
Зарегистрированные пользователи могут отправлять пожертвования и просматривать список своих пожертвований.


<h2>Техническая документация</h2>

Для просмотра документации загрузите файл на сайт _https://redocly.github.io/redoc/_. Вверху страницы есть кнопка Upload a file, нажмите её и загрузит файл `openapi.json` который находится в базовой директории. Спецификация проекта отобразится в формате ReDoc. Ваш API должен соответствовать всем требованиям документации.

В приложении должно быть три модели: 
- Пользователи
- Проекты
- Пожертвования

Пользователи

Все настройки пользователей возьмите из проекта по бронированию переговорок.
- Используйте библиотеку FastAPI Users.
- В настройках укажите транспорт Bearer и стратегию JWT.
- Подключите роутеры Auth Router, Register Router, Users Router.
- Не изменяйте базовую модель пользователя.
- Установите запрет на удаление пользователей: эндпоинт удаления пользователя переопределите на deprecated.

Проекты

Создайте модель CharityProject, свяжите её с таблицей `charityproject` в базе данных. 
Столбцы таблицы `charityproject`:
- id — первичный ключ;
- name — уникальное название проекта, обязательное строковое поле; допустимая длина строки — от 1 до 100 символов включительно;
- description — описание, обязательное поле, текст; не менее одного символа;
- full_amount — требуемая сумма, целочисленное поле; больше 0;
- invested_amount — внесённая сумма, целочисленное поле; значение по умолчанию — 0;
- fully_invested — булево значение, указывающее на то, собрана ли нужная сумма для проекта (закрыт ли проект); значение по умолчанию — False;
- create_date — дата создания проекта, тип DateTime, должно добавляться автоматически в момент создания проекта.
- close_date — дата закрытия проекта, DateTime, проставляется автоматически в момент набора нужной суммы.
Права пользователей
Любой посетитель сайта (в том числе неавторизованный) может посмотреть список всех проектов.
Суперпользователь может: 
- создавать проекты,
- удалять проекты, в которые не было внесено средств,
- изменять название и описание существующего проекта, устанавливать для него новую требуемую сумму (но не меньше уже внесённой).
Никто не может менять через API размер внесённых средств, удалять или модифицировать закрытые проекты, изменять даты создания и закрытия проектов.

Пожертвования
Создайте модель Donation, свяжите её с таблицей donation в базе данных.
Столбцы таблицы donation:
- id — первичный ключ;
- user_id — id пользователя, сделавшего пожертвование. Foreign Key на поле user.id из таблицы пользователей;
- comment — необязательное текстовое поле;
- full_amount — сумма пожертвования, целочисленное поле; больше 0;
- invested_amount — сумма из пожертвования, которая распределена по проектам; значение по умолчанию равно 0;
- fully_invested — булево значение, указывающее на то, все ли деньги из пожертвования были переведены в тот или иной проект; по умолчанию равно False;
- create_date — дата пожертвования; тип DateTime; добавляется автоматически в момент поступления пожертвования;
- close_date — дата, когда вся сумма пожертвования была распределена по проектам; тип DateTime; добавляется автоматически в момент выполнения условия.

Права пользователей
Любой зарегистрированный пользователь может сделать пожертвование.
Зарегистрированный пользователь может просматривать только свои пожертвования, при этом ему выводится только четыре поля:
- id
- comment
- full_amount
- create_date
Информация о том, инвестировано пожертвование в какой-то проект или нет, обычному пользователю недоступна.
Суперпользователь может просматривать список всех пожертвований, при этом ему выводятся все поля модели.
Редактировать или удалять пожертвования не может никто.

Процесс «инвестирования»

Сразу после создания нового проекта или пожертвования должен запускаться процесс «инвестирования» (увеличение `invested_amount` как в пожертвованиях, так и в проектах, установка значений `fully_invested` и `close_date`, при необходимости). 
Если создан новый проект, а в базе были «свободные» (не распределённые по проектам) суммы пожертвований — они автоматически должны инвестироваться в новый проект, и в ответе API эти суммы должны быть учтены. То же касается и создания пожертвований: если в момент пожертвования есть открытые проекты, эти пожертвования должны автоматически зачислиться на их счета.
Функции, отвечающие за инвестирование, должны вызываться непосредственно из API-функций, отвечающих за создание пожертвований и проектов. Сами функции инвестирования (или одну универсальную функцию) можно расположить в директории app/services/ в отдельном файле с подходящим именем.
Важно! В процессе инвестиций вызывайте метод `commit()` только в самом конце функции, когда все расчёты уже произведены. Это гарантирует, что все операции будут произведены за единую транзакцию, и никто из других пользователей не изменит состояние проектов или пожертвований, пока осуществляются подсчёты для инвестиции.
После коммита выполните `refresh()` того объекта, который вы будете возвращать из эндпоинта, иначе при выполнении кода будет выброшена ошибка `sqlalchemy.exc.MissingGreenlet: greenlet_spawn has not been called; can't call await_only()` here.


<h2>Используемые технологии</h2>

- aiosqlite==0.17.0
- alembic==1.7.7
- anyio==3.6.1
- asgiref==3.5.2
- attrs==21.4.0
- bcrypt==3.2.2
- certifi==2022.5.18.1
- cffi==1.15.0
- charset-normalizer==2.0.12
- click==8.1.3
- cryptography==37.0.2
- dnspython==2.2.1
- email-validator==1.2.1
- faker==12.0.1
- fastapi-users-db-sqlalchemy==4.0.3
- fastapi-users[sqlalchemy]==10.0.4
- fastapi==0.78.0
- flake8==4.0.1
- freezegun==1.2.1
- greenlet
- h11==0.13.0
- httptools
- idna==3.3
- iniconfig==1.1.1
- makefun==1.13.1
- mako==1.2.0
- markupsafe==2.1.1
- mccabe==0.6.1
- mixer==7.2.2
- packaging==21.3; python_version >= '3.6'
- passlib[bcrypt]==1.7.4
- pluggy==1.0.0
- py==1.11.0
- pycodestyle==2.8.0
- pycparser==2.21
- pydantic
- pyflakes==2.4.0
- pyjwt[crypto]==2.3.0
- pyparsing==3.0.9
- pytest-asyncio==0.18.3
- pytest-freezegun==0.4.2
- pytest-pythonpath==0.7.4
- pytest==6.2.5
- python-dateutil==2.8.2
- python-dotenv==0.20.0
- python-multipart==0.0.5
- pyyaml==6.0
- requests==2.27.1
- six==1.16.0
-  sniffio==1.2.0
- sqlalchemy==1.4.36
- starlette==0.19.1
- toml==0.10.2
- typing-extensions==4.2.0
- urllib3==1.26.9
- uvicorn[standard]==0.17.6
- watchgod==0.8.2
- websockets==10.3




<h2>Как использовать</h2>

Клонировать репозиторий и перейти в него в командной строке:

```
git clone 
```

```
cd cat_charity_fund

```

Cоздать и активировать виртуальное окружение:

```
python3 -m venv venv
```

* Если у вас Linux/macOS

    ```
    source venv/bin/activate
    ```
* Если у вас windows

    ```
    source venv/scripts/activate
    ```


Установить зависимости из файла requirements.txt:

```
python3 -m pip install --upgrade pip
```

```
pip install -r requirements.txt
```
Заполнить файл .env по аналогу .env.example

Установить alembic и выполнить миграции

# alembic init --template async alembic 
# alembic revision --autogenerate -m "Add table reservation"
# alembic upgrade head



Запустить приложение 

```
uvicorn app.main:app --reload
```